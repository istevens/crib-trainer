<!DOCTYPE html>
<html>
<head>
    <script type="module" src="https://cardmeister.github.io/elements.cardmeister.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0 user-scalable=no" />
    <script type="module" src="src/cribbagescorer.js"></script>
    <style>
        html {
            background: rgba(0,120,52,1);
            background: fixed radial-gradient(circle at 50% 10rem, rgba(0,200,40,1) 0%, rgba(0,120,24,1) 40%, rgba(0,0,0,1) 100%);
            font-family: Helvetica, sans-serif;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: pan-x pan-y;
            height: 100%;
        }

        #play img {
            width: 18vw;
            margin: 0 0.5rem;
            max-width: 10rem;
        }

        #play {
            display: flex;
            align-items: center;
            flex-direction: column;
            gap: 2rem;
        }

        #hand, #cutCard img {
            border-radius: 11.5px;
        }

        select {
            width: 10rem;
        }

        #hand, #cutCard img {
            padding: 0.5rem;
            border: 0.2rem solid rgb(255, 255, 130, 0.5);
        }

        #cutCard img {
            outline: 0.2rem solid rgb(255, 255, 130, 0.5);
            outline-offset: 0.3rem;
        }

        #cribbagescorer {
            width: 100%;
        }

        #score {
            position: fixed;
            top: 1rem;
            right: 1rem;
            height: 3rem;
            width: 6rem;

            display: flex;
            flex-direction: row;
            align-items: center;

            color: white;
            font-weight: bold;
        }

        #score span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50%;
            height: 100%;
        }

        #score #successes {
            background-color: green;
        }

        #score #failures {
            background-color: red;
        }

        #tricks #lastHand {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        #tricks img {
            height: 5em;
        }

        #trickList {
            list-style: none;
            display: contents;
        }

        #trickList li {
            display: flex;
            flex-direction: row;
            align-items: center;
            visibility: hidden;
        }

        #trickList li>span:first-child {
            width: 5em;
            text-transform: capitalize;
            visibility: visible;
        }

        #trickList li>span:last-child {
            width: 100%;
            max-width: 18em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trick {
            height: 6em;
            transform: rotateZ(3deg);
            margin-right: 5em;
            visibility: visible;
        }

        .trick img {
            position: absolute;
            transform-origin: bottom left;
        }

        .trick .card13 img, .trick .card14 img, .trick .card15 img {transform: rotateZ(342deg)}
        .trick .card12 img, .trick .card23 img, .trick .card24 img, .trick .card25 img {transform: rotateZ(351deg)}
        .trick .card22 img, .trick .card33 img, .trick .card34 img, .trick .card35 img {transform: rotateZ(0)}
        .trick .card44 img, .trick .card45 img {transform: rotateZ(9deg)}
        .trick .card55 img {transform: rotateZ(18deg)}
        }

    </style>
</head>
<body>
    <div id="cribbagescorer">

        <div id="score"><span id="successes">0</span><span id="failures">0</span></div>

        <div id="play">
            <div id="cutCard"></div>
            <div id="hand"></div>
            <form>
                <select id="scoreSelect">
                    <option disabled>This hand's score is:</option>
                </select>
            </form>
        </div>

        <dialog id="tricks">
            <button autofocus>Close</button>
            <div id="lastHand"></div>
            <ul id="trickList"></ul>
        </dialog>
    </div>

    <script type="module">
        import CribbageHand from "./src/cribbagescorer.js";

        const _getEl = x => document.getElementById(x);
        const SCORE_SELECTED = "scoreSelected";
        const NEW_ROUND = "newRound";
        const cardTemplate = (card, i, a) => `<card-t cid="${card}" class="card${i+1}${a.length}"></card-t>`;

        var play = null;

        function renderCards(cards, el) {
            var cards = cards.map(cardTemplate).join("");
            el && (el.innerHTML = cards);
            return cards;
        }

        function displayNextHand() {
            play = CribbageHand.randomPlay();

            renderCards([play.cutCard], _getEl('cutCard'));
            renderCards(play.hand.cards, _getEl('hand'));

            var select = _getEl('scoreSelect');
            select.selectedIndex = 0;
            select.focus();
            select.blur();
        }

        function handWasScored(ev) {
            var score = this.value;
            var expected = play.hand.getScore(play.cutCard);
            var evPayload = {bubbles: true, detail: {play: play, selectedScore: score}};

            this.dispatchEvent(new CustomEvent(SCORE_SELECTED, evPayload));
            this.dispatchEvent(new CustomEvent(NEW_ROUND, evPayload));
        }

        function changeScore(ev) {
            var play = ev.detail.play;
            var selectedScore = ev.detail.selectedScore;
            var score = this.querySelector('#score');

            var actualScore = play.hand.getScore(play.cutCard);
            var successes = score.querySelector('#successes');
            var failures = score.querySelector('#failures');
            var elemToIncr = (selectedScore == actualScore) && successes || failures;
            elemToIncr.textContent = parseInt(elemToIncr.textContent) + 1;
        }

        function renderTrick(t) {
            var [name, tricks] = t;
            var hasTricks = tricks.length > 0;
            tricks = hasTricks && tricks.map(x => `<span class='trick'>${renderCards(x)}</span>`) || "<span>" + t[1] + "</span>";
            const trickTemplate = `<li><span>${name}</span>:<span>${tricks}</span></li>`;

            tricks = hasTricks && trickTemplate || "";
            return tricks;
        }

        function showTricks(ev) {
            var play = ev.detail.play;
            var tricksEl = document.querySelector('ul#trickList');
            var tricks = play.hand.getTricks(play.cutCard);
            tricks = Object.entries(tricks).map(renderTrick);

            renderCards(play.hand.cards.concat(play.cutCard), _getEl('lastHand'));
            tricksEl.innerHTML = tricks.join("");

            _getEl('correctScore').innerHTML = `${play.hand.getScore(play.cutCard)}`;

            var dialog = document.querySelector('dialog#tricks');
            dialog.showModal();
        }

        function setup() {
            var selector = _getEl('scoreSelect');
            new Array(30).fill().map((x, i) => {
                var o = document.createElement('option');
                o.label = o.value = i;
                selector.appendChild(o);
            });

            selector.addEventListener('change', handWasScored);

            var scorer = _getEl('cribbagescorer');
            scorer.addEventListener(SCORE_SELECTED, changeScore);
            scorer.addEventListener(SCORE_SELECTED, showTricks);
            scorer.addEventListener(NEW_ROUND, displayNextHand);

            var dialog = scorer.querySelector("dialog");
            dialog.querySelector("button").addEventListener("click", () => dialog.close());
        }

        setup();
        displayNextHand();

    </script>
</body>
</html>
