<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no"/>
    <script type="module" src="https://cardmeister.github.io/elements.cardmeister.min.js"></script>
    <script type="module" src="src/cribbagescorer.js"></script>
    <style>
        body {
            background: rgb(0,199,34);
            background: fixed radial-gradient(circle at 50% 12%, rgba(0,199,34,1) 0%, rgba(1,152,34,1) 49%, rgba(0,120,52,1) 100%);
        }

        img {
            width: 20vw;
            margin: 2vw;
            border: 1px solid black;
            border-radius: 10px;
        }

        #cribbagescorer {
            width: 100%;
        }

        #cribbagescorer > * {
            display: flex;
            justify-content: center;
        }

        #score {
            position: fixed;
            right: 1rem;
            color: white;
            font-size: 2rem;
        }

        #score span {
            background: white;
            padding: 1rem;
            width: 2rem;
        }

        #score #successes {
            text-align: right;
            padding-right: 1rem;
            background-color: green;
        }

        #score #failures {
            text-align: left;
            padding-left: 1rem;
            background-color: red;
        }
    </style>
</head>
<body>
    <div id="cribbagescorer">

        <div id="score"><span id="successes">0</span><span id="failures">0</span></div>

        <div id="cutCard"></div>

        <div id="hand"></div>

        <form>
            <select id="scoreSelect">
                <option disabled>This hand's score is:</option>
            </select>
        </form>
    </div>

    <script type="module">
        import CribbageHand from "./src/cribbagescorer.js";

        const _getEl = x => document.getElementById(x);
        const SCORE_SELECTED = "scoreSelected";
        const NEW_ROUND = "newRound";

        var play = null;

        function displayNextHand() {
            play = CribbageHand.randomPlay();

            var cutCard = _getEl('cutCard');
            var card = play.cutCard;
            const cardTemplate = (card) => `<card-t cid="${card}"></card-t>`;
            cutCard.innerHTML = cardTemplate(card);

            var hand = _getEl('hand');
            var cards = play.hand.cards.map(card => cardTemplate(card));
            cards = cards.join("");
            hand.innerHTML = cards;

            var select = _getEl('scoreSelect');
            select.selectedIndex = 0;
        }

        function handWasScored(ev) {
            var score = this.value;
            var expected = play.hand.getScore(play.cutCard);
            var evPayload = {bubbles: true, detail: {play: play, selectedScore: score}};

            this.dispatchEvent(new CustomEvent(SCORE_SELECTED, evPayload));
            this.dispatchEvent(new CustomEvent(NEW_ROUND, evPayload));
        }

        function changeScore(ev) {
            var play = ev.detail.play;
            var selectedScore = ev.detail.selectedScore;
            var score = this.querySelector('#score');

            var actualScore = play.hand.getScore(play.cutCard);
            var successes = score.querySelector('#successes');
            var failures = score.querySelector('#failures');
            var elemToIncr = (selectedScore == actualScore) && successes || failures;
            elemToIncr.textContent = parseInt(elemToIncr.textContent) + 1;
        }

        function setup() {
            var selector = _getEl('scoreSelect');
            new Array(30).fill().map((x, i) => {
                var o = document.createElement('option');
                o.label = o.value = i;
                selector.appendChild(o);
            });

            selector.addEventListener('change', handWasScored);

            var scorer = _getEl('cribbagescorer');
            scorer.addEventListener(SCORE_SELECTED, changeScore);
            scorer.addEventListener(NEW_ROUND, displayNextHand);
        }

        setup();
        displayNextHand();

    </script>
</body>
</html>
