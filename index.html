<!DOCTYPE html>
<html>
<head>
    <title>Crib Trainer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no" />
    <script type="module" src="src/elements.cardmeister.min.js"></script>
    <style>
        :root {
            --tableColour: rgb(0, 200, 40);
            --tableDecorColour: hsl(60, 100%, 75%, 0.5);
            --titleColour: hsl(60, 100%, 75%, 0.75);
            --uiElementBorder: 0.2rem solid var(--tableDecorColour);
            --successColour: chartreuse;
            --failureColour: red;
            --dialogColour: hsl(43, 100%, 92%);
            --dialogDecorColour: hsl(43, 100%, 20%);
            --cardWidth: 5rem;
            --buttonWidth: 12rem;
            --svgTrianglesInactive: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -8 8 16"><polygon points="8,-1 4.5,-8 1,-1" fill="black"/><polygon points="4.5,8 1,1 8,1" fill="black"/></svg>');
            --svgTrianglesActive: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -8 8 16"><polygon points="8,-1 4.5,-8 1,-1" fill="rgba(255, 255, 130, 0.5)"/><polygon points="4.5,8 1,1 8,1" fill="rgba(255, 255, 130, 0.5)"/></svg>');
        }

        * {
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            margin: 0;
            height: 100%;
            font-family: Helvetica, sans-serif;
            background: var(--tableColour);
        }

        dialog, ::backdrop, #cribtrainer {
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
        }

        dialog {
            background-color: var(--dialogColour);
            border: 1px solid black;
            max-width: 90%;
        }

        select {
            appearance: none;
            background-image: var(--svgTrianglesInactive);
            background-repeat: no-repeat;
            background-position: right 0.5em center;
            background-size: 0.5em;
            padding-right: 1.5em !important;
        }

        :is(:hover, :focus) {
            outline: none;
        }

        h1 {
            margin: 0.5rem;
        }

        h1 a {
            display: block;
            margin: auto;
            aspect-ratio: 1704 / 321;
            max-width: 40rem;
            color: transparent;
            background: var(--titleColour);
            mask-image: url(cribtrainer-arched.svg);
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
        }

        card-set {
            pointer-events: none;
        }

        a {
            text-decoration: none;
            color: inherit;
            width: 100%;
        }

        li {
            list-style: none;
        }

        ul {
            padding-inline-start: 0;
            margin-inline-start: 0;
        }

        card-set::part(card) {
            width: var(--cardWidth);
        }

        #cribtrainer {
            background: fixed radial-gradient(circle at 50% 10rem, var(--tableColour) 0%, rgb(0,120,24) 40%, rgb(0,0,0) 100%);
            height: 100%;
        }

        #table {
            max-width: 40rem;
            margin: 0 auto;
        }

        #table nav *, select {
            text-align: center;
            background-color: transparent;
            font-size: 2rem;
            color: var(--tableDecorColour);
            cursor: pointer;
        }

        #table nav * {
            width: var(--buttonWidth);
        }

        :is(#table nav *):hover {
            background-color: var(--tableDecorColour);
            color: black;
        }

        :is(#table nav *.primary):hover {
            color: var(--tableDecorColour);
            background-color: transparent;
        }

        #table .activeContent {
            display: flex;
            flex-direction: column;
            place-items: center;
            gap: 2rem;
        }

        #table>section:not(.activeContent) {
            display: none;
        }

        #play {
            --cardWidth: 9rem;
            position: relative;
        }

        #hand, #cutCard, #table nav *, select {
            padding: 0.5rem;
            border: var(--uiElementBorder);
        }

        #hand, #lastHand {
            grid-template-columns: repeat(3, minmax(2rem, 1fr)) 1fr;
            justify-items: left;
        }

        #hand {
            gap: 0.5rem;
            max-width: 85vw;
        }

        #hand, dialog, #cutCard, #table nav *, select {
            border-radius: 11.5px;
        }

        #table nav *.primary,
        #cutCard {
            outline: var(--uiElementBorder);
            outline-offset: 0.3rem;
        }

        #table nav *.primary,
        select {
            color: black;
            background-color: var(--tableDecorColour);
        }

        #score {
            display: flex;
            position: absolute;
            right: 1rem;
            height: 3rem;
            width: 6rem;
            font-weight: bold;
        }

        #score span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50%;
            height: 100%;
        }

        #score #successes {
            background-color: var(--successColour);
            color: black;
        }

        #score #failures {
            background-color: var(--failureColour);
            color: white;
        }

        #lastPlay, #trickList, #trickList li, #correctScore, #start nav {
            display: contents;
        }

        #lastPlay {
            --cardWidth: 6rem;
        }

        #lastCutCard {
            justify-self: left;
        }

        #intro {
            --cardWidth: 5rem;
        }

        dialog li ul {
            position: relative;
            display: flex;
            justify-content: space-evenly;
            flex-wrap: wrap;
            place-items: center;
        }

        #exampleTricks, #tricksContainer {
            display: grid;
            align-items: center;
        }

        #exampleTricks {
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            max-width: 50rem;
        }

        #tricksContainer {
            grid-template-columns: 6rem minmax(var(--cardWidth), 1fr) minmax(calc(var(--cardWidth) + 3rem), 2fr);
            gap: 0rem 1rem;
        }

        .trickLabel {
            display: flex;
            flex-direction: column;
            text-align: center;
            place-items: center;
        }

        #correctScore {
            font-size: 4rem;
        }

        #trickList .trickLabel {
            font-size: 3rem;
        }

        .trickLabel {
            position: relative;
            font-weight: bold;
        }

        .trickLabel::before {
            position: absolute;
            left: 0;
            font-size: 2rem;
            font-weight: bold;
        }

        #trickList li:first-child .trickLabel::before {
            content: '=';
        }

        #trickList li:not(:first-child) .trickLabel::before {
            content: '+';
        }

        #trickList li:only-child .trickScore {
            display: none;
        }

        #trickList li:only-child .trickLabel::before {
            content: '';
        }

        #trickList ul {
            grid-column: 2 / span 2;
            padding-left: 1.5rem;
        }

        #trickList li:first-child ul, #trickList li:first-child>span {
            padding-top: 1.25rem;
        }

        #trickList li:first-child:has(ul>li) ul::before {
            position: absolute;
            width: 50%;
            content: '';
            top: 0.5rem;
            border-width: 1px 0 0 0;
            border-image: radial-gradient(circle, var(--dialogDecorColour), 75%, rgba(0,0,0,0)) 1 0;
            border-style: solid;
        }

        .trickScore {
            line-height: 75%;
        }

        .trickDescription {
            width: 75%;
            font-size: 1rem;
        }

        #selectedScore {
            position: absolute;
            visibility: hidden;
            width: 100%;
            top: 20%;
            font-size: 24em;
            font-weight: bold;
            letter-spacing: -0.1em;
            text-indent: -0.1em;
            text-align: center;
            filter: blur(0);
            transition: filter 500ms ease-in;
        }

        #selectedScore.active {
            visibility: visible;
            filter: blur(0.25em);
        }

        #selectedScore.correct {
            color: var(--successColour);
        }

        #selectedScore.incorrect {
            color: var(--failureColour);
        }

        @media (hover: hover) {
            select:hover {
                color: var(--tableDecorColour);
                background-color: transparent;
                background-image: var(--svgTrianglesActive);
            }
        }

        @media (orientation: landscape) {
            #tricksContainer {
                max-width: 40rem;
            }

            #play nav {
                position: fixed;
                top: 1rem;
                left: 1rem;
            }

            #score {
                position: fixed;
                right: 1rem;
                top: 1rem;
            }
        }

        @media (orientation: landscape) and (hover: none) {
            #table {
                margin-top: 1rem;
                margin-left: 3rem;
            }

            #table .activeContent {
                flex-direction: row;
            }

            #play nav {
                left: 3rem;
            }
        }
    </style>
</head>
<body>
    <div id="cribtrainer">
        <h1><a href="#" tabindex="0">Crib Trainer</a></h1>

        <section id="table">
            <section id="start">
                <h2>Score your cribbage hands faster and easier!</h2>
                <nav>
                    <a role="button" class="primary" href="#play" autofocus tabindex="0">Play</a>
                    <button class="instructionsButton" command="show-modal" commandfor="instructions">Scoring</button>
                </nav>
            </section>

            <section id="play">
                <section id="score"><span id="successes">0</span><span id="failures">0</span></section>

                <card-set id="cutCard"></card-set>
                <card-set id="hand" jitter="3"></card-set>
                <select id="scoreSelect" autofocus>
                    <option disabled>This hand's score is:</option>
                </select>

                <nav>
                    <button class="instructionsButton" command="show-modal" commandfor="instructions">Instructions</button>
                </nav>
            </section>
        </section>

        <dialog id="instructions">
            <h2>Scoring</h2>
            <ul id="exampleTricks">
                <li><span>Cards totalling 15 score 2 points.</span><ul>
                    <li><card-set cards="JH,5C" arrangeBy="fan"></card-set></li>
                    <li><card-set cards="2H,3C,7D,AS,AC" arrangeBy="fan"></card-set></li>
                </ul></li>
                <li>Pairs score 2 points each, eg.<ul>
                    <li><card-set cards="3C,3D" arrangeBy="fan"></card-set></li>
                    <li><card-set cards="8C,8H" arrangeBy="fan"></card-set></li>
                </ul></li>
                <li>Triplets score 6 points each, eg.<ul>
                    <li><card-set cards="9C,9D,9H" arrangeBy="fan"></card-set></li>
                </ul></li>
                <li>Four-of-a-kind scores 12 points, eg.<ul>
                    <li><card-set cards="QH,QS,QD,QC" arrangeBy="fan"></card-set></li>
                </ul></li>
                <li>Runs of 3, 4, or 5 score 1 point for each card, eg.<ul>
                    <li><card-set cards="6D,7C,8H" arrangeBy="fan"></card-set><li>
                    <li><card-set cards="10H,JS,QD,KC" arrangeBy="fan"></card-set></li>
                </ul></li>
                <li>A jack in the hand with the same suit as the cut card scores one point, eg.<ul>
                    <li><card-set cards="10C,JC" arrangeBy="fan"></card-set></li>
                </ul></li>
            </ul>
            <form><button command="close" formmethod="dialog">Close</button></form>
        </dialog>

        <dialog id="tricks">
            <div id="tricksContainer">
                <section id="lastPlay">
                    <div id="correctScore">
                        <span class="trickLabel">
                            <span class="trickDescription">
                                Score is
                            </span>
                            <span class="trickScore"></span>
                        </span>
                    </div>
                    <card-set id="lastCutCard"></card-set>
                    <card-set id="lastHand" jitter="2"></card-set>
                </section>
                <ul id="trickList"></ul>
            </div>
            <form><button command="close" formmethod="dialog">Close</button></form>
        </dialog>

        <div id="selectedScore"></div>
    </div>

    <script type="module">
        import "./src/cribbagescorer.js";

        const STYLE = new CSSStyleSheet();
        STYLE.replaceSync(`
            :host {
                --cardset-card-count: 0;
                --cardset-card-rotation: 7;
                --cardset-card-width: 5rem;
                display: grid;
                width: auto;
                justify-items: center;
            }

            ::part(card) {
                width: var(--cardset-card-width);
            }

            :host([arrangeBy=row]) {
                grid-template-columns: repeat(auto-fit, minmax(1rem, 1fr));
            }

            :host([arrangeBy=row])::part(card) {
                --xyjitterbase: calc(0.25rem * var(--cardset-card-jitter));
                --rotjitterbase: calc(3deg * var(--cardset-card-jitter));
                transform: translate(
                    calc(var(--xyjitterbase) * var(--cardset-card-xjitter)),
                    calc(var(--xyjitterbase) * var(--cardset-card-yjitter))
                ) rotateZ(calc(var(--rotjitterbase) * var(--cardset-card-rotjitter)));
            }

            :host([arrangeBy=fan]) {
                --cardset-card-maxrotation: calc(var(--cardset-card-rotation) * var(--cardset-card-count) / 2);
                --cardset-card-maxrotationrad: calc(var(--cardset-card-maxrotation) * 3.14159 / 180);
                --cardset-card-padding: calc(var(--cardset-card-width) * abs(sin(var(--cardset-card-maxrotationrad))));
                padding-top: var(--cardset-card-padding);
                padding-right: calc(var(--cardset-card-padding) * 5/7);
            }

            :host([arrangeBy=fan])::part(card) {
                grid-area: 1 / 1;
                --cardset-card-thiscardrotation: calc(
                    360deg + var(--cardset-card-rotation) * 1deg
                        * (var(--cardset-card-number) - 1/2 * var(--cardset-card-count))
                    );
                transform: rotateZ(var(--cardset-card-thiscardrotation));
                transform-origin: left bottom;
            }
        `);

        class CardSetComponent extends HTMLElement {
            static observedAttributes = ['cards'];
            static STYLE_PREFIX = '--cardset-card-';

            constructor() {
                super();
                this.attachShadow({mode: "open"});
                this.shadowRoot.adoptedStyleSheets = [STYLE];
                this.cardCount = 0;

                let jitter = this.getAttribute('jitter');
                jitter = jitter == "" && 1 || jitter || 0;
                this.setAttribute('jitter', jitter);
                this.setAttribute('arrangeBy', this.getAttribute('arrangeBy') || 'row');
            }

            cardTemplate(card, i, a) {
                let rand = () => Math.random() - 0.5;
                let jitters = ['x', 'y', 'rot'];
                jitters = jitters.map(x => [x + 'jitter', rand()]);

                let style = jitters.concat([['number', i]]);
                style = style.concat([['jitter', this.getAttribute('jitter')]]);
                style = style.map(x => CardSetComponent.STYLE_PREFIX + x[0] + ': ' + x[1]);
                style = style.join('; ');

                let j = this.getAttribute('jitter');
                let html = `<playing-card part="card" cid="${card}" style="${style}"></playing-card>`;
                return html;
            }

            renderCards() {
                let cards = this.getAttribute('cards');
                cards = cards && cards.split(',') || [];
                this.cardCount = cards.length;
                cards = cards.map(x => x.trim());
                let html = cards.map((...x) => this.cardTemplate(...x)).join("");
                return html;
            }

            attributeChangedCallback(name, newVal, oldVal) {
                let shouldRender = name == 'cards' && newVal != oldVal;
                shouldRender && (this.shadowRoot.innerHTML = this.renderCards());
                shouldRender && (this.style.setProperty('--cardset-card-count', this.cardCount));
            }
        }

        customElements.define("card-set", CardSetComponent);
    </script>
    <script type="module">
        import CribbageHand from "./src/cribbagescorer.js";

        const _getEl = x => document.getElementById(x);
        const isTouch = 'ontouchstart' in window;

        var play = null;
        const SCORE_SELECTED = "scoreSelected";
        const SCORE_INCORRECT = "scoreIncorrect";
        const NEW_ROUND = "newRound";

        const scoreTemplate = (name, score, tricks) => {
            var n = tricks.length;
            var isHisNobs = name.includes('nobs');
            name = !isHisNobs && (n == 1 && 'a' || n == 0 && 'no' || n) + ' ' + name || name;
            name = !isHisNobs && n == 1 && name.replace(/s$/, '') || name;
            var html = `<span class="trickScore">${score}</span>
                <span class="trickDescription">for ${name}</span>`;
            return html;
        };
        const trickLabelTemplate = (name, score, tricks) => `<span class="trickLabel">${scoreTemplate(name, score, tricks)}</span>`;
        const tricksTemplate = (name, score, tricks) => `<li>${trickLabelTemplate(name, score, tricks)}<ul>${tricks.join("")}</ul></li>`;
        const trickTemplate = x => `<li><card-set class='trick' cards='${x}' arrangeBy='fan'></card-set></li>`;

        function displayNextHand() {
            play = CribbageHand.randomPlay();

            _getEl('cutCard').setAttribute('cards', [play.cutCard]);
            _getEl('hand').setAttribute('cards', play.hand.cards);

            var select = _getEl('scoreSelect');
            select.selectedIndex = 0;
            select.focus();
            isTouch && select.blur();
        }

        function handWasScored(ev) {
            var selected = this.value;
            var expected = play.hand.getScore(play.cutCard);
            var evPayload = {bubbles: true, detail: {
                    play: play,
                    selectedScore: selected,
                    expectedScore: expected,
                    scoresMatch: selected == expected
            }};

            this.dispatchEvent(new CustomEvent(SCORE_SELECTED, evPayload));
        }

        function changeScore(ev) {
            var successes = '#successes';
            var failures = '#failures';
            var elemToIncr = ev.detail.scoresMatch && successes || failures;
            var score = this.querySelector('#score');

            elemToIncr = score.querySelector(elemToIncr);
            elemToIncr.textContent = parseInt(elemToIncr.textContent) + 1;
        }

        function clearScoreSelection(ev) {
            var el = this.querySelector('#selectedScore');
            el.classList.remove('correct', 'incorrect', 'active');
        }

        function showScoreSelection(ev) {
            var selectedScore = ev.detail.selectedScore;
            var scoresMatch = ev.detail.scoresMatch;
            var el = this.querySelector('#selectedScore');
            el.textContent = selectedScore;
            el.classList.toggle("active");
            el.classList.toggle(scoresMatch && "correct" || "incorrect");

            var nev = scoresMatch && NEW_ROUND || SCORE_INCORRECT;
            nev = new CustomEvent(nev, {bubbles: true, detail: ev.detail});
            this.addEventListener(
                'transitionend', x => {this.dispatchEvent(nev)}, {once: true}
            );
        }

        function renderTrick(t) {
            var tricks = t[1].data.map(trickTemplate);
            tricks = tricksTemplate(t[0], t[1].score, tricks);
            return tricks;
        }

        function showTricks(ev) {
            play = ev.detail.play;
            var cutCard = play.cutCard;
            var hand = play.hand;

            _getEl('lastCutCard').setAttribute('cards', [cutCard]);
            _getEl('lastHand').setAttribute('cards', hand.cards);
            this.querySelector('#correctScore .trickScore').innerHTML = ev.detail.expectedScore;

            var tricksEl = this.querySelector('ul#trickList');
            var tricks = Object.entries(hand.getTricks(cutCard));
            var hasTricks = tricks.length > 0;
            tricksEl.innerHTML = hasTricks && tricks.map(renderTrick).join("") || tricksTemplate("tricks", 0, []);

            var dialog = this.querySelector('dialog#tricks');
            dialog.showModal();
        }

        function populateScoreOptions() {
            var selector = _getEl('scoreSelect');
            new Array(30).fill().map((x, i) => {
                var o = document.createElement('option');
                o.label = o.value = i;
                selector.appendChild(o);
            });
        }

        function addEventListeners() {
            var trainer = _getEl('cribtrainer');
            var selector = _getEl('scoreSelect');
            trainer.addEventListener(SCORE_SELECTED, changeScore);
            trainer.addEventListener(SCORE_SELECTED, showScoreSelection);
            trainer.addEventListener(SCORE_INCORRECT, showTricks);
            trainer.addEventListener(SCORE_INCORRECT, clearScoreSelection)
            trainer.addEventListener(NEW_ROUND, displayNextHand);
            trainer.addEventListener(NEW_ROUND, clearScoreSelection);
            selector.addEventListener('change', handWasScored);

            var startNewRound = () => trainer.dispatchEvent(new CustomEvent(NEW_ROUND, {bubbles: true}));
            var switchSections = ev => {
                    var location = window.location.hash.replace('#', '');
                    location = [location || 'start'];
                    var sections = ['.activeContent', '#' + location];
                    sections.map(x => {
                        x = trainer.querySelector(x);
                        x = x && x.classList.toggle('activeContent');
                    });
                    startNewRound();
                };
            window.addEventListener('hashchange', switchSections);
            switchSections();

            var tricks = trainer.querySelector("dialog#tricks");
            tricks.addEventListener("click", () => tricks.close());
            tricks.addEventListener("close", startNewRound);

            var instrButtons = trainer.querySelectorAll(".instructionsButton");
            Array.from(instrButtons, x => x.addEventListener('click', () => trainer.querySelector('dialog#instructions').showModal()));

            // Prevent double-tap to zoom and long-press
            document.addEventListener('dblclick', (event) => event.preventDefault());
            document.addEventListener('contextmenu', (event) => event.preventDefault());
        }

        function setup() {
            populateScoreOptions();
            addEventListeners();
        }

        setup();

    </script>
</body>
</html>
