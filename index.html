<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no" />
    <script type="module" src="src/elements.cardmeister.min.js"></script>
    <style>
        :root {
            --tableDecorColor: rgb(255, 255, 130, 0.5);
            --cardPlacementBorder: 0.2rem solid var(--tableDecorColor);
        }

        html, body {
            margin: 0;
            height: 100%;
            font-family: Helvetica, sans-serif;
        }

        dialog, ::backdrop, #cribtrainer {
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
        }

        select {
            width: 10rem;
        }

        h1 {
            text-align: center;
            color: var(--tableDecorColor);
        }

        #cribtrainer {
            background: rgba(0,120,52,1);
            background: fixed radial-gradient(circle at 50% 10rem, rgba(0,200,40,1) 0%, rgba(0,120,24,1) 40%, rgba(0,0,0,1) 100%);
            height: 100%;
            display: relative;
        }

        card-set:not([arrangeBy='fan']) {
            display: flex;
            justify-content: center;
        }

        #play card-set::part(card) {
            width: 20vw;
            max-width: 10rem;
        }

        #play {
            display: flex;
            align-items: center;
            flex-direction: column;
            gap: 2rem;
        }

        #hand, #cutCard {
            display: flex;
        }

        #hand, #tricks, #cutCard {
            border-radius: 11.5px;
        }

        #hand, #cutCard {
            padding: 0.5rem;
            border: var(--cardPlacementBorder);
        }

        #cutCard {
            outline: var(--cardPlacementBorder);
            outline-offset: 0.3rem;
        }

        #score {
            position: fixed;
            top: 1rem;
            right: 1rem;
            height: 3rem;
            width: 6rem;

            display: flex;
            flex-direction: row;
            align-items: center;

            color: white;
            font-weight: bold;
        }

        #score span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50%;
            height: 100%;
        }

        #score #successes {
            background-color: green;
        }

        #score #failures {
            background-color: red;
        }

        #tricks {
            background-color: beige;
            border: 1px solid black;
        }

        #tricks card-set#lastHand::part(card) {
            width: 6rem;
        }

        #trickList {
            list-style: none;
            display: contents;
        }

        #trickList card-set::part(card) {
            width: 4.5rem;
        }

        #trickList li {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            visibility: hidden;
        }

        #trickList li span {
            visibility: visible;
        }

        #correctScore, #trickList .trickLabel {
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        #tricks:has(#correctScore .trickScore) #trickList .trickLabel {
            display: none;
        }

        #trickList .trickLabel {
            width: 5em;
            visibility: visible;
        }

        .trickScore {
            position: relative;
            font-weight: bold;
            line-height: 75%;
        }

        .trickLabel .trickScore {
            font-size: 3rem;
        }

        #trickList li:not(:first-child) .trickScore::before {
            position: absolute;
            right: 3rem;
            content: '+\00A0';
            font-size: 0.33em;
        }

        .trickName {
            font-size: 0.75rem;
            font-weight: bold;
        }

        #trickList li>span:last-child {
            width: 100%;
            max-width: 18em;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            column-gap: 1rem;
        }

        #correctScore {
            margin: 1rem;
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
        }

        #selectedScore {
            position: absolute;
            visibility: hidden;
            width: 100%;
            top: 20%;
            font-size: 24em;
            font-weight: bold;
            pointer-events: none;
            letter-spacing: -0.1em;
            text-indent: -0.1em;
            text-align: center;
            filter: blur(0);
            transition: filter 500ms ease-in;
        }

        #selectedScore.active {
            visibility: visible;
            filter: blur(0.25em);
        }

        #selectedScore.correct {
            color: chartreuse;
        }

        #selectedScore.incorrect {
            color: red;
        }

    </style>
</head>
<body>
    <div id="cribtrainer">
        <h1>Crib Trainer</h1>

        <div id="score"><span id="successes">0</span><span id="failures">0</span></div>

        <div id="play">
            <card-set id="cutCard"></card-set>
            <card-set id="hand"></card-set>
            <form>
                <select id="scoreSelect">
                    <option disabled>This hand's score is:</option>
                </select>
            </form>
        </div>

        <dialog id="tricks">
            <card-set id="lastHand"></card-set>
            <div id="correctScore"></div>
            <ul id="trickList"></ul>
            <button>Close</button>
        </dialog>

        <div id="selectedScore"></div>
    </div>

    <script type="module">
        import "./src/cribbagescorer.js";

        const STYLE = new CSSStyleSheet();
        STYLE.replaceSync(`
            :host {
                display: inline-block;
            }

            :host::part(card) {
                width: 5rem;
            }

            :host([arrangeBy=fan]) {
                --cardset-card-count: 0;
                --cardset-card-rotation: 7deg;
                display: grid;
            }

            :host([arrangeBy=fan])::part(card) {
                grid-area: 1 / 1;
                transform: rotateZ(calc(
                    360deg + var(--cardset-card-rotation)
                        * (var(--cardset-card-number) - 1/2 * var(--cardset-card-count))
                ));
                transform-origin: left bottom;
            }
        `);

        const cardTemplate = (card, i, a) => `<card-t part="card" cid="${card}" class="card_${i+1}_${a.length}" style="--cardset-card-number: ${i}"></card-t>`;

        class CardSetComponent extends HTMLElement {
            static observedAttributes = ['cards'];

            constructor() {
                super();
                this.arrangeBy = this.getAttribute('arrangeBy') || 'row';
                this.jitter = this.getAttribute('jitter') || 0;
                this.attachShadow({mode: "open"});
                this.shadowRoot.adoptedStyleSheets = [STYLE];
                this.cardCount = 0;
            }

            renderCards() {
                let cards = this.getAttribute('cards');
                cards = cards && cards.split(',') || [];
                this.cardCount = cards.length;
                cards = cards.map(x => x.trim());
                let html = cards.map(cardTemplate).join("");
                return html;
            }

            attributeChangedCallback(name, newVal, oldVal) {
                let shouldRender = name == 'cards' && newVal != oldVal;
                shouldRender && (this.shadowRoot.innerHTML = this.renderCards());
                shouldRender && (this.style.setProperty('--cardset-card-count', this.cardCount));
            }
        }

        customElements.define("card-set", CardSetComponent);
    </script>
    <script type="module">
        import CribbageHand from "./src/cribbagescorer.js";

        var play = null;
        const _getEl = x => document.getElementById(x);

        const SCORE_SELECTED = "scoreSelected";
        const SCORE_INCORRECT = "scoreIncorrect";
        const NEW_ROUND = "newRound";

        const scoreTemplate = (name, score, tricks) => {
            var n = tricks.length;
            var isHisNobs = name.includes('nobs');
            name = !isHisNobs && (n == 1 && 'a' || n) + ' ' + name || name;
            name = !isHisNobs && n == 1 && name.replace(/s$/, '') || name;
            var html = `<span class="trickScore">${score}</span>
                <span class="trickName">for ${name}</span>`;
            return html;
        };
        const tricksTemplate = (name, score, tricks) => `<li><span class="trickLabel">${scoreTemplate(name, score, tricks)}</span>:<span>${tricks.join("")}</span></li>`;
        const trickTemplate = x => `<card-set class='trick' cards='${x}' arrangeBy='fan'></card-set>`;

        function displayNextHand() {
            play = CribbageHand.randomPlay();

            _getEl('cutCard').setAttribute('cards', [play.cutCard]);
            _getEl('hand').setAttribute('cards', play.hand.cards);

            var select = _getEl('scoreSelect');
            select.selectedIndex = 0;
            select.blur();
        }

        function handWasScored(ev) {
            var selected = this.value;
            var expected = play.hand.getScore(play.cutCard);
            var evPayload = {bubbles: true, detail: {
                    play: play,
                    selectedScore: selected,
                    expectedScore: expected,
                    scoresMatch: selected == expected
            }};

            this.dispatchEvent(new CustomEvent(SCORE_SELECTED, evPayload));
        }

        function changeScore(ev) {
            var successes = '#successes';
            var failures = '#failures';
            var elemToIncr = ev.detail.scoresMatch && successes || failures;
            var score = this.querySelector('#score');

            elemToIncr = score.querySelector(elemToIncr);
            elemToIncr.textContent = parseInt(elemToIncr.textContent) + 1;
        }

        function clearScoreSelection(ev) {
            var el = this.querySelector('#selectedScore');
            el.classList.remove('correct', 'incorrect', 'active');
        }

        function showScoreSelection(ev) {
            var selectedScore = ev.detail.selectedScore;
            var scoresMatch = ev.detail.scoresMatch;
            var el = this.querySelector('#selectedScore');
            el.textContent = selectedScore;
            el.classList.toggle("active");
            el.classList.toggle(scoresMatch && "correct" || "incorrect");

            var nev = scoresMatch && NEW_ROUND || SCORE_INCORRECT;
            nev = new CustomEvent(nev, {bubbles: true, detail: ev.detail});
            this.addEventListener(
                'transitionend', x => {this.dispatchEvent(nev)}, {once: true}
            );
        }

        function renderTrick(t) {
            var trickData = t[1].data;
            var hasTricks = trickData.length > 0;
            var tricks = hasTricks && trickData.map(trickTemplate);
            tricks = hasTricks && tricksTemplate(t[0], t[1].score, tricks) || "";
            return tricks;
        }

        function showTricks(ev) {
            var play = ev.detail.play;
            var cutCard = play.cutCard;
            var hand = play.hand;
            var tricks = Object.entries(hand.getTricks(cutCard));
            var firstAndOnlyTrick = tricks.length == 1 && tricks[0];

            _getEl('lastHand').setAttribute('cards', hand.cards.concat(cutCard));

            var score = firstAndOnlyTrick && scoreTemplate(firstAndOnlyTrick[0], firstAndOnlyTrick[1].score, firstAndOnlyTrick[1].data) || ev.detail.expectedScore;
            _getEl('correctScore').innerHTML = score;

            var tricksEl = document.querySelector('ul#trickList');
            tricksEl.innerHTML = tricks.map(renderTrick).join("");

            var dialog = document.querySelector('dialog#tricks');
            dialog.showModal();
        }

        function setup() {
            var selector = _getEl('scoreSelect');
            new Array(30).fill().map((x, i) => {
                var o = document.createElement('option');
                o.label = o.value = i;
                selector.appendChild(o);
            });

            selector.addEventListener('change', handWasScored);

            var trainer = _getEl('cribtrainer');
            trainer.addEventListener(SCORE_SELECTED, changeScore);
            trainer.addEventListener(SCORE_SELECTED, showScoreSelection);
            trainer.addEventListener(SCORE_INCORRECT, showTricks);
            trainer.addEventListener(NEW_ROUND, displayNextHand);
            trainer.addEventListener(NEW_ROUND, clearScoreSelection);

            var dialog = trainer.querySelector("dialog");
            var closeTricks = ev => dialog.dispatchEvent(new CustomEvent(NEW_ROUND, {bubbles: true})) && dialog.close();
            dialog.addEventListener("click", closeTricks);
            dialog.addEventListener("close", closeTricks);

            closeTricks();
        }

        setup();

    </script>
</body>
</html>
